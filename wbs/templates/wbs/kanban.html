{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Project Items ‚Äî Board</title>
    <link rel="stylesheet" href="{% static 'wbs/gantt.css' %}">
    <style>
        :root {
            --board-bg: #0f172a;
            --column-bg: #111827;
            --card-bg: #1f2937;
            --card-border: #293548;
            --text: #e5e7eb;
            --muted: #9ca3af;
            --accent: #22d3ee;
            --accent-2: #a855f7;
        }
        body {
            margin: 0;
            font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
            background: radial-gradient(circle at 20% 20%, #111827 0, #0b1220 40%, #0a0f1c 70%);
            color: var(--text);
        }
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            border-bottom: 1px solid #1f2937;
            background: linear-gradient(120deg, rgba(34, 211, 238, 0.08), rgba(168, 85, 247, 0.08));
        }
        h1 {
            margin: 0;
            font-size: 20px;
            letter-spacing: 0.02em;
        }
        a:focus-visible,
        button:focus-visible,
        .card:focus-visible,
        input[type="checkbox"]:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 3px;
        }
        .board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 14px;
            padding: 16px 18px 24px;
        }
        .column {
            background: var(--column-bg);
            border: 1px solid #1f2937;
            border-radius: 10px;
            min-height: 220px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.28);
            display: flex;
            flex-direction: column;
        }
        .column-header {
            padding: 12px 14px;
            border-bottom: 1px solid #1f2937;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .pill {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.08);
            color: var(--muted);
        }
        .card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 12px;
            margin: 12px 12px 0;
            box-shadow: 0 8px 16px rgba(0,0,0,0.25);
        }
        .card h3 {
            margin: 0 0 6px;
            font-size: 15px;
        }
        .card .wbs {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 6px;
        }
        .meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .priority {
            border: 1px solid rgba(255,255,255,0.1);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
        }
        .priority.critical { color: #f87171; border-color: rgba(248,113,113,0.3); }
        .priority.high { color: #fb923c; border-color: rgba(251,146,60,0.3); }
        .priority.medium { color: #22d3ee; border-color: rgba(34,211,238,0.25); }
        .priority.low { color: #a3e635; border-color: rgba(163,230,53,0.25); }
        .empty {
            margin: 20px 12px;
            color: var(--muted);
            font-size: 13px;
            text-align: center;
        }
        footer {
            text-align: center;
            padding: 16px;
            color: var(--muted);
            font-size: 12px;
        }
        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .btn-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 8px;
            background: rgba(34, 211, 238, 0.14);
            border: 1px solid rgba(34, 211, 238, 0.35);
            color: var(--text);
            text-decoration: none;
            font-weight: 600;
            letter-spacing: 0.01em;
        }
        .btn-link:hover {
            background: rgba(34, 211, 238, 0.22);
            border-color: rgba(34, 211, 238, 0.45);
        }
        .drop-hover {
            outline: 2px dashed rgba(34, 211, 238, 0.6);
            outline-offset: -6px;
            background: rgba(34, 211, 238, 0.04);
        }
        .dragging {
            opacity: 0.65;
            transform: scale(0.99);
        }
        .column-body {
            flex: 1;
            padding-bottom: 12px;
        }
        .filter-active .card {
            display: none;
        }
        .filter-active .card.matches-filter {
            display: block;
        }
        @media (max-width: 700px) {
            .board { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
        }
    </style>
</head>
<body>
    <header>
        <div>
            <div style="font-size:12px; text-transform: uppercase; letter-spacing: 0.2em; color: var(--muted);">House Project</div>
            <h1>Project Items Board</h1>
        </div>
        <div class="header-actions">
            <div style="display: flex; gap: 8px; align-items: center;">
                <button id="toggle-filters" class="btn-link" style="cursor:pointer;" aria-expanded="false" aria-controls="filter-panel">‚äï Filters</button>
                <a href="{% url 'gantt' %}" class="btn-link" aria-label="Back to Gantt view">‚Üê Gantt view</a>
                <div class="pill">Grouped by status</div>
            </div>
        </div>
    </header>

    <section id="filter-panel" style="display:none; padding: 16px 24px; border-bottom: 1px solid #1f2937; background: rgba(34,211,238,0.06);" aria-hidden="true">
        <div style="display: flex; gap: 24px; flex-wrap: wrap;">
            <div>
                <div style="font-weight: 600; margin-bottom: 8px; font-size: 12px; text-transform: uppercase; color: var(--muted);">Type</div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <label><input type="checkbox" name="filter-type" value="issue"> Issue</label>
                    <label><input type="checkbox" name="filter-type" value="task"> Task</label>
                    <label><input type="checkbox" name="filter-type" value="enhancement"> Enhancement</label>
                    <label><input type="checkbox" name="filter-type" value="risk"> Risk</label>
                    <label><input type="checkbox" name="filter-type" value="decision"> Decision</label>
                </div>
            </div>
            <div>
                <div style="font-weight: 600; margin-bottom: 8px; font-size: 12px; text-transform: uppercase; color: var(--muted);">Priority</div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <label><input type="checkbox" name="filter-priority" value="critical"> Critical</label>
                    <label><input type="checkbox" name="filter-priority" value="high"> High</label>
                    <label><input type="checkbox" name="filter-priority" value="medium"> Medium</label>
                    <label><input type="checkbox" name="filter-priority" value="low"> Low</label>
                </div>
            </div>
            <div>
                <div style="font-weight: 600; margin-bottom: 8px; font-size: 12px; text-transform: uppercase; color: var(--muted);">Status</div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <label><input type="checkbox" name="filter-status" value="backlog"> Backlog</label>
                    <label><input type="checkbox" name="filter-status" value="in_progress"> In Progress</label>
                    <label><input type="checkbox" name="filter-status" value="review"> Review</label>
                    <label><input type="checkbox" name="filter-status" value="done"> Done</label>
                </div>
            </div>
            <div>
                <div style="font-weight: 600; margin-bottom: 8px; font-size: 12px; text-transform: uppercase; color: var(--muted);">Owner (Resource)</div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <label><input type="checkbox" name="filter-owner" value="owner-unassigned"> Unassigned</label>
                    <label><input type="checkbox" name="filter-owner" value="owner-any"> (any with owner)</label>
                </div>
            </div>
            <div>
                <button id="apply-filters" class="btn-link" style="cursor:pointer; margin-top: 20px;" aria-label="Apply filters">Apply</button>
                <button id="clear-filters" class="btn-link" style="cursor:pointer; margin-top: 20px; margin-left: 8px;" aria-label="Clear filters">Clear</button>
            </div>
        </div>
    </section>

    <section class="board">
        {% for column in columns %}
            <div class="column" data-status="{{ column.status }}" role="region" aria-label="Status {{ column.label }} column">
                <div class="column-header">
                    <span>{{ column.label }}</span>
                    <span class="pill column-count">{{ column.items|length }}</span>
                </div>

                <div class="column-body">
                    {% if column.items %}
                        {% for item in column.items %}
                            <div class="card" draggable="true" tabindex="0" role="article"
                                 aria-label="{{ item.title }} ‚Äî {{ item.get_status_display }} ‚Äî {{ item.get_priority_display }}"
                                 data-id="{{ item.id }}" data-type="{{ item.type }}" data-priority="{{ item.priority }}" data-status="{{ item.status }}" data-owner="{{ item.owner|default:'' }}">
                                <div class="wbs">
                                    {% if item.wbs_item %}
                                        {{ item.wbs_item.code }} ‚Äî {{ item.wbs_item.name }}
                                    {% else %}
                                        Unassigned
                                    {% endif %}
                                </div>
                                <h3>{{ item.title }}</h3>
                                {% if item.description %}
                                    <div class="wbs" style="margin-bottom:8px;">{{ item.description|truncatechars:120 }}</div>
                                {% endif %}
                                <div class="meta">
                                    <span class="priority {{ item.priority }}">{{ item.get_priority_display }}</span>
                                    <span class="pill">{{ item.get_type_display }}</span>
                                    {% if item.owner %}
                                        <span class="pill" style="background: rgba(168,85,247,0.2); border-color: rgba(168,85,247,0.4); color: #a855f7;">üë§ {{ item.owner }}</span>
                                    {% else %}
                                        <span class="pill" style="color: var(--muted);">No owner</span>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty">No items in this status yet.</div>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </section>

    <footer>Tip: expand filters in Gantt to target items, then switch here for board view.</footer>
    <!-- Hidden form just to expose CSRF token for JS and ensure cookie is set -->
    <form style="display:none;">{% csrf_token %}</form>
    <script>
        (function() {
            const FILTER_KEY = 'boardFilters';
            const filterPanel = document.getElementById('filter-panel');
            const toggleFilterBtn = document.getElementById('toggle-filters');
            const applyFilterBtn = document.getElementById('apply-filters');
            const clearFilterBtn = document.getElementById('clear-filters');
            const board = document.querySelector('.board');

            // Load and apply saved filters on page load
            function loadFilters() {
                const saved = localStorage.getItem(FILTER_KEY);
                if (!saved) return;
                try {
                    const filters = JSON.parse(saved);
                    Object.entries(filters).forEach(([key, values]) => {
                        values.forEach(val => {
                            const checkbox = document.querySelector(`input[name="filter-${key}"][value="${val}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    });
                } catch (_) {
                    // ignore parse errors
                }
            }

            function getActiveFilters() {
                const filters = { type: [], priority: [], status: [], owner: [] };
                document.querySelectorAll('input[name^="filter-"]:checked').forEach(cb => {
                    const key = cb.name.replace('filter-', '');
                    if (filters.hasOwnProperty(key)) {
                        filters[key].push(cb.value);
                    }
                });
                return filters;
            }

            function cardMatchesFilters(card, filters) {
                if (!filters.type.length && !filters.priority.length && !filters.status.length && !filters.owner.length) {
                    return true;
                }
                const type = card.dataset.type || '';
                const priority = card.dataset.priority || '';
                const status = card.closest('.column')?.dataset.status || '';
                const owner = card.dataset.owner || '';

                const typeMatch = !filters.type.length || filters.type.includes(type);
                const priorityMatch = !filters.priority.length || filters.priority.includes(priority);
                const statusMatch = !filters.status.length || filters.status.includes(status);

                // Owner filter special handling
                let ownerMatch = true;
                if (filters.owner.length) {
                    const hasUnassignedFilter = filters.owner.includes('owner-unassigned');
                    const hasAnyOwnerFilter = filters.owner.includes('owner-any');

                    if (hasUnassignedFilter && hasAnyOwnerFilter) {
                        // Both checked: show all
                        ownerMatch = true;
                    } else if (hasUnassignedFilter) {
                        // Only unassigned: show items with no owner
                        ownerMatch = !owner;
                    } else if (hasAnyOwnerFilter) {
                        // Only "any with owner": show items that have an owner
                        ownerMatch = !!owner;
                    }
                }

                return typeMatch && priorityMatch && statusMatch && ownerMatch;
            }

            function applyFilters() {
                const filters = getActiveFilters();
                const hasFilters = filters.type.length || filters.priority.length || filters.status.length;

                if (hasFilters) {
                    localStorage.setItem(FILTER_KEY, JSON.stringify(filters));
                    board.classList.add('filter-active');
                } else {
                    localStorage.removeItem(FILTER_KEY);
                    board.classList.remove('filter-active');
                }

                document.querySelectorAll('.card').forEach(card => {
                    if (hasFilters) {
                        if (cardMatchesFilters(card, filters)) {
                            card.classList.add('matches-filter');
                        } else {
                            card.classList.remove('matches-filter');
                        }
                    } else {
                        card.classList.remove('matches-filter');
                    }
                });
            }

            // Toggle filter panel
            toggleFilterBtn.addEventListener('click', () => {
                const isHidden = filterPanel.style.display === 'none';
                const nextDisplay = isHidden ? 'block' : 'none';
                filterPanel.style.display = nextDisplay;
                filterPanel.setAttribute('aria-hidden', isHidden ? 'false' : 'true');
                toggleFilterBtn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
            });

            // Apply filters
            applyFilterBtn.addEventListener('click', () => {
                applyFilters();
                filterPanel.style.display = 'none';
                filterPanel.setAttribute('aria-hidden', 'true');
                toggleFilterBtn.setAttribute('aria-expanded', 'false');
            });

            // Clear filters
            clearFilterBtn.addEventListener('click', () => {
                document.querySelectorAll('input[name^="filter-"]:checked').forEach(cb => {
                    cb.checked = false;
                });
                localStorage.removeItem(FILTER_KEY);
                board.classList.remove('filter-active');
                document.querySelectorAll('.card').forEach(card => {
                    card.classList.remove('matches-filter');
                });
                filterPanel.style.display = 'none';
                filterPanel.setAttribute('aria-hidden', 'true');
                toggleFilterBtn.setAttribute('aria-expanded', 'false');
            });

            // Set data attributes on cards for filtering
            document.querySelectorAll('.card').forEach(card => {
                const meta = card.querySelector('.meta');
                if (meta) {
                    const pills = meta.querySelectorAll('.pill');
                    if (pills.length > 0) {
                        const typeText = pills[pills.length - 1]?.textContent?.toLowerCase() || '';
                        const typeMap = { 'issue': 'issue', 'task': 'task', 'enhancement': 'enhancement', 'risk': 'risk', 'decision': 'decision' };
                        const type = Object.keys(typeMap).find(k => typeText.includes(k)) || '';
                        if (type) card.dataset.type = type;
                    }
                    const priority = card.querySelector('.priority');
                    if (priority) {
                        card.dataset.priority = priority.className.split(' ').find(c => ['critical', 'high', 'medium', 'low'].includes(c)) || '';
                    }
                }
            });

            loadFilters();
            applyFilters();

            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(";").shift();
            }

            const csrfToken =
                getCookie("csrftoken") ||
                document.querySelector('input[name="csrfmiddlewaretoken"]')?.value ||
                document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
                '';
            const statusUpdateUrl = "{% url 'project_item_status_update' %}";

            function updateCount(column) {
                const countEl = column.querySelector('.column-count');
                if (countEl) {
                    countEl.textContent = column.querySelectorAll('.card').length;
                }
            }

            function refreshEmptyState(column) {
                const body = column.querySelector('.column-body');
                if (!body) return;
                const hasCard = body.querySelector('.card');
                let empty = body.querySelector('.empty');
                if (hasCard && empty) {
                    empty.remove();
                } else if (!hasCard && !empty) {
                    empty = document.createElement('div');
                    empty.className = 'empty';
                    empty.textContent = 'No items in this status yet.';
                    body.appendChild(empty);
                }
            }

            let draggingCard = null;

            document.querySelectorAll('.card').forEach(card => {
                card.setAttribute('draggable', 'true');

                card.addEventListener('dragstart', (e) => {
                    draggingCard = card;
                    card.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                });
            });

            document.querySelectorAll('.column').forEach(column => {
                column.addEventListener('dragover', (e) => {
                    if (!draggingCard) return;
                    e.preventDefault();
                    column.classList.add('drop-hover');
                });

                column.addEventListener('dragleave', () => {
                    column.classList.remove('drop-hover');
                });

                column.addEventListener('drop', (e) => {
                    e.preventDefault();
                    column.classList.remove('drop-hover');
                    const card = draggingCard;
                    if (!card) return;

                    const sourceColumn = card.closest('.column');
                    const targetStatus = column.dataset.status;
                    const cardId = card.dataset.id;

                    if (!targetStatus || !cardId || sourceColumn === column) {
                        draggingCard = null;
                        return;
                    }

                    fetch(statusUpdateUrl, {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({ id: cardId, status: targetStatus }),
                    })
                        .then(async (resp) => {
                            const text = await resp.text();
                            if (!resp.ok) {
                                let detail = text || `HTTP ${resp.status}`;
                                try {
                                    const data = JSON.parse(text);
                                    detail = data.error || detail;
                                } catch (_) {
                                    /* ignore parse errors */
                                }
                                throw new Error(detail);
                            }
                            let data = {};
                            try {
                                data = JSON.parse(text);
                            } catch (_) {
                                data = {};
                            }
                            if (!data.ok) throw new Error(data.error || 'Update failed');

                            const targetBody = column.querySelector('.column-body');
                            if (!targetBody) return;

                            card.remove();
                            targetBody.appendChild(card);
                            updateCount(sourceColumn);
                            updateCount(column);
                            refreshEmptyState(sourceColumn);
                            refreshEmptyState(column);
                        })
                        .catch((err) => {
                            console.error(err);
                            const detail = err?.message ? ` (${err.message})` : '';
                            alert(`Could not move card.${detail}`);
                        });
                });
            });
        })();
    </script>
</body>
</html>
